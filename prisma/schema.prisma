generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DealCategoryMaster {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  description String?
  icon        String?  @db.VarChar(100)
  color       String?  @db.VarChar(7)
  sortOrder   Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deals       Deal[]

  @@index([active, sortOrder])
}

model DealTypeMaster {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deals       Deal[]

  @@index([active])
}

model PointEventTypeMaster {
  id          Int              @id @default(autoincrement())
  name        String           @unique @db.VarChar(50)
  description String?
  points      Int
  active      Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  pointEvents UserPointEvent[]

  @@index([active])
}

model User {
  id                 Int                  @id @default(autoincrement())
  email              String               @unique
  name               String?
  password           String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  role               UserRole             @default(USER)
  points             Int                  @default(0)
  monthlyPoints      Int                  @default(0)
  referralCode       String?              @unique
  referredByUserId   Int?
  birthday           DateTime?
  avatarUrl          String?
  coins              Int                  @default(0)
  experiencePoints   Int                  @default(0)
  loyaltyTier        LoyaltyTier          @default(BRONZE)
  totalSpent         Float                @default(0)
  bookings           Booking[]
  checkIns           CheckIn[]
  CoinTransaction    CoinTransaction[]
  kickbackEvents     KickbackEvent[]
  merchant           Merchant?
  PaymentTransaction PaymentTransaction[]
  referredBy         User?                @relation("UserReferrals", fields: [referredByUserId], references: [id])
  referrals          User[]               @relation("UserReferrals")
  UserAchievement    UserAchievement[]
  savedDeals         UserDeal[]
  pointEvents        UserPointEvent[]

  @@index([referredByUserId])
  @@index([loyaltyTier])
  @@index([totalSpent])
}

model Merchant {
  id              Int              @id @default(autoincrement())
  businessName    String
  address         String
  description     String?
  logoUrl         String?
  status          MerchantStatus   @default(PENDING)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  ownerId         Int              @unique
  latitude        Float?
  longitude       Float?
  city            String?
  phoneNumber     String?
  businessType    BusinessType     @default(LOCAL)
  bookings        Booking[]
  bookingSettings BookingSettings?
  deals           Deal[]
  kickbackEvents  KickbackEvent[]
  menuCollections MenuCollection[]
  menuItems       MenuItem[]
  owner           User             @relation(fields: [ownerId], references: [id])
  stores          Store[]
  tables          Table[]
  timeSlots       TimeSlot[]
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Deal {
  id                     Int                @id @default(autoincrement())
  title                  String
  description            String
  discountPercentage     Int?
  discountAmount         Float?
  startTime              DateTime
  endTime                DateTime
  redemptionInstructions String
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  merchantId             Int
  recurringDays          String?
  imageUrls              String[]
  kickbackEnabled        Boolean            @default(false)
  offerTerms             String?
  categoryId             Int
  dealTypeId             Int
  checkIns               CheckIn[]
  category               DealCategoryMaster @relation(fields: [categoryId], references: [id])
  dealType               DealTypeMaster     @relation(fields: [dealTypeId], references: [id])
  merchant               Merchant           @relation(fields: [merchantId], references: [id])
  menuItems              DealMenuItem[]
  kickbackEvents         KickbackEvent[]
  savedByUsers           UserDeal[]
  pointEvents            UserPointEvent[]
}

model UserDeal {
  id      Int      @id @default(autoincrement())
  userId  Int
  dealId  Int
  savedAt DateTime @default(now())
  deal    Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dealId])
}

model UserPointEvent {
  id               Int                  @id @default(autoincrement())
  userId           Int
  dealId           Int?
  points           Int
  createdAt        DateTime             @default(now())
  pointEventTypeId Int
  deal             Deal?                @relation(fields: [dealId], references: [id])
  pointEventType   PointEventTypeMaster @relation(fields: [pointEventTypeId], references: [id])
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, pointEventTypeId])
  @@index([userId, dealId])
  @@index([createdAt])
  @@index([createdAt, userId])
}

model CheckIn {
  id             Int      @id @default(autoincrement())
  userId         Int
  dealId         Int
  merchantId     Int
  latitude       Float
  longitude      Float
  distanceMeters Float
  createdAt      DateTime @default(now())
  deal           Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, dealId])
  @@index([merchantId])
}

model City {
  id        Int      @id @default(autoincrement())
  name      String
  state     String
  active    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stores    Store[]

  @@unique([name, state])
  @@index([active, name])
}

model Store {
  id         Int      @id @default(autoincrement())
  merchantId Int
  cityId     Int
  address    String
  latitude   Float?
  longitude  Float?
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  city       City     @relation(fields: [cityId], references: [id])
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([cityId])
  @@index([active, cityId])
}

model MenuItem {
  id                 Int                  @id @default(autoincrement())
  merchantId         Int
  name               String
  description        String?
  price              Float
  category           String
  imageUrl           String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  happyHourPrice     Float?
  isHappyHour        Boolean              @default(false)
  dealType           MenuDealType         @default(STANDARD)
  isSurprise         Boolean              @default(false)
  surpriseRevealTime String?
  validDays          String?
  validEndTime       String?
  validStartTime     String?
  dealLinks          DealMenuItem[]
  collectionItems    MenuCollectionItem[]
  merchant           Merchant             @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([merchantId, dealType])
  @@index([merchantId, isHappyHour])
  @@index([dealType])
}

model DealMenuItem {
  dealId            Int
  menuItemId        Int
  isHidden          Boolean  @default(false)
  assignedAt        DateTime @default(now())
  customDiscount    Float?
  customPrice       Float?
  discountAmount    Float?
  useGlobalDiscount Boolean  @default(true)
  deal              Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  menuItem          MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@id([dealId, menuItemId])
  @@index([menuItemId])
  @@index([dealId])
}

model MenuCollection {
  id          Int                  @id @default(autoincrement())
  merchantId  Int
  name        String
  description String?
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  merchant    Merchant             @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  items       MenuCollectionItem[]

  @@index([merchantId])
  @@index([merchantId, isActive])
  @@index([name])
}

model MenuCollectionItem {
  collectionId   Int
  menuItemId     Int
  sortOrder      Int            @default(0)
  isActive       Boolean        @default(true)
  customPrice    Float?
  customDiscount Float?
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  collection     MenuCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  menuItem       MenuItem       @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@id([collectionId, menuItemId])
  @@index([collectionId])
  @@index([menuItemId])
  @@index([collectionId, sortOrder])
}

model KickbackEvent {
  id                Int      @id @default(autoincrement())
  merchantId        Int
  dealId            Int
  userId            Int
  amountEarned      Float
  sourceAmountSpent Float
  inviteeCount      Int      @default(1)
  createdAt         DateTime @default(now())
  deal              Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  merchant          Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([merchantId, createdAt])
  @@index([userId])
  @@index([dealId])
  @@index([userId, createdAt])
}

model Table {
  id         Int         @id @default(autoincrement())
  merchantId Int
  name       String
  capacity   Int
  features   String[]
  status     TableStatus @default(AVAILABLE)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  bookings   Booking[]
  merchant   Merchant    @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([merchantId, status])
  @@index([status])
}

model TimeSlot {
  id          Int       @id @default(autoincrement())
  merchantId  Int
  dayOfWeek   Int
  startTime   String
  endTime     String
  duration    Int
  maxBookings Int
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  bookings    Booking[]
  merchant    Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId, dayOfWeek])
  @@index([merchantId, dayOfWeek, startTime])
  @@index([isActive])
}

model Booking {
  id               Int           @id @default(autoincrement())
  merchantId       Int
  tableId          Int
  timeSlotId       Int
  userId           Int
  bookingDate      DateTime
  partySize        Int
  status           BookingStatus @default(PENDING)
  specialRequests  String?
  contactPhone     String?
  contactEmail     String?
  confirmationCode String        @unique
  notes            String?
  confirmedAt      DateTime?
  cancelledAt      DateTime?
  cancelledBy      Int?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  merchant         Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  table            Table         @relation(fields: [tableId], references: [id], onDelete: Cascade)
  timeSlot         TimeSlot      @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([merchantId, bookingDate])
  @@index([merchantId, status])
  @@index([userId])
  @@index([tableId, bookingDate])
  @@index([timeSlotId, bookingDate])
  @@index([bookingDate, status])
  @@index([confirmationCode])
}

model BookingSettings {
  id                   Int      @id @default(autoincrement())
  merchantId           Int      @unique
  advanceBookingDays   Int      @default(30)
  minPartySize         Int      @default(1)
  maxPartySize         Int      @default(12)
  bookingDuration      Int      @default(120)
  requiresConfirmation Boolean  @default(true)
  allowsModifications  Boolean  @default(true)
  allowsCancellations  Boolean  @default(true)
  cancellationHours    Int      @default(24)
  autoConfirm          Boolean  @default(false)
  sendReminders        Boolean  @default(true)
  reminderHours        Int      @default(2)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  merchant             Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
}

model Achievement {
  id              Int               @id @default(autoincrement())
  name            String            @unique
  description     String
  type            AchievementType
  icon            String?
  coinReward      Int               @default(0)
  xpReward        Int               @default(0)
  criteria        Json
  isActive        Boolean           @default(true)
  sortOrder       Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  UserAchievement UserAchievement[]

  @@index([isActive, sortOrder])
  @@index([type, isActive])
}

model CoinTransaction {
  id                 Int                 @id @default(autoincrement())
  userId             Int
  type               CoinTransactionType
  amount             Int
  balanceBefore      Int
  balanceAfter       Int
  description        String
  metadata           Json?
  relatedPaymentId   Int?
  createdAt          DateTime            @default(now())
  PaymentTransaction PaymentTransaction? @relation(fields: [relatedPaymentId], references: [id])
  User               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([type])
  @@index([userId, createdAt])
}

model LoyaltyTierConfig {
  id                 Int         @id @default(autoincrement())
  tier               LoyaltyTier @unique
  minSpent           Float
  coinMultiplier     Float       @default(1.0)
  discountPercentage Float       @default(0)
  specialPerks       Json?
  tierColor          String?
  tierIcon           String?
  isActive           Boolean     @default(true)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  @@index([isActive])
  @@index([minSpent])
}

model PaymentTransaction {
  id              Int               @id @default(autoincrement())
  userId          Int
  paypalOrderId   String?           @unique
  paypalPaymentId String?
  amount          Float
  coinsPurchased  Int
  status          PaymentStatus     @default(PENDING)
  paypalResponse  Json?
  failureReason   String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  CoinTransaction CoinTransaction[]
  User            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([paypalOrderId])
  @@index([paypalPaymentId])
  @@index([status])
  @@index([userId, createdAt])
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        Int
  achievementId Int
  progress      Json
  isCompleted   Boolean     @default(false)
  completedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  Achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  User          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([achievementId])
  @@index([userId, isCompleted])
}

enum UserRole {
  USER
  MERCHANT
  ADMIN
}

enum MerchantStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum BusinessType {
  NATIONAL
  LOCAL
}

enum DealCategory {
  FOOD_AND_BEVERAGE
  RETAIL
  ENTERTAINMENT
  HEALTH_AND_FITNESS
  BEAUTY_AND_SPA
  AUTOMOTIVE
  TRAVEL
  EDUCATION
  TECHNOLOGY
  HOME_AND_GARDEN
  OTHER
}

enum DealType {
  STANDARD
  HAPPY_HOUR
  RECURRING
}

enum MenuDealType {
  HAPPY_HOUR_BOUNTY
  HAPPY_HOUR_SURPRISE
  HAPPY_HOUR_LATE_NIGHT
  HAPPY_HOUR_MID_DAY
  HAPPY_HOUR_MORNINGS
  REDEEM_NOW_BOUNTY
  REDEEM_NOW_SURPRISE
  STANDARD
  RECURRING
}

enum PointEventType {
  SIGNUP
  FIRST_CHECKIN_DEAL
  CHECKIN
  COIN_PURCHASE
  ACHIEVEMENT_UNLOCK
  LOYALTY_BONUS
  REFERRAL_BONUS
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  OUT_OF_ORDER
}

enum AchievementType {
  FIRST_PURCHASE
  SPENDING_MILESTONE
  CHECK_IN_STREAK
  REFERRAL_COUNT
  DEAL_SAVER
  LOYALTY_TIER
  SPECIAL_EVENT
}

enum CoinTransactionType {
  PURCHASE
  EARNED
  SPENT
  BONUS
  REFUND
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}
